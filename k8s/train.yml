#@ load("@ytt:data", "data")

apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: bert-spam-detector
  namespace: argo
spec:
  entrypoint: bert-spam-detector
  templates:
    - name: bert-spam-detector
      steps:
      - - name: bert-spam-detector-training
          template: bert-spam-detector-training

    - name: bert-spam-detector-training
      container:
        image: localhost:32000/bert-spam-detector-train:latest
        command: ["python"]
        args:
          - training/train.py
          - --training_data
          - data/spam-labels.csv
          - --model_output_directory
          - /tmp/mldata/
        resources:
          limits:
            nvidia.com/gpu: "1"
        volumeMounts:
          - name: mldata-volume
            mountPath: /tmp/mldata
    - name: bert-spam-detector-archive
      container:
        image: pytorch/torchserve:latest
        command: ["torch-model-archiver"]
        args:
          - --model-name
          - bert-spam-detector
          - --version
          - 1.0
          - --model-file
          - /tmp/mldata/saved_weights.pth
          - --handler
          - inference/transformerhandler.py

  volumes:
    - name: mldata-volume
      hostPath:
        path: #@ data.values.model_dir
        type: Directory